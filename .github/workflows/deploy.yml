name: Deploy to EC2

on:
  push:
    branches: [main] # Triggers when you push to main branch
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests (if you have any)
        run: npm test || echo "No tests found"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v3

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            # Ensure nvm + Node 20 are available in this non-interactive shell
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            nvm install 20
            nvm use 20

            APP_DIR="/home/ec2-user/apps/az-cars-backend"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            # Pull cleanly
            if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
              git remote set-url origin https://github.com/edemking/az-cars-backend.git
              git fetch origin main
              git reset --hard origin/main
            else
              git clone https://github.com/edemking/az-cars-backend.git .
              git checkout main
            fi

            # Install deps
            if [ -f package-lock.json ]; then
              npm ci --omit=dev
            else
              npm install --omit=dev
            fi

            # Start or reload PM2 (handles the "not found" case)
            if pm2 describe az-cars-backend >/dev/null 2>&1; then
              pm2 reload az-cars-backend --update-env
            else
              pm2 start src/index.js --name az-cars-backend
              pm2 save
            fi

            # Optional brief logs (no streaming)
            pm2 status az-cars-backend || true
            tail -n 80 ~/.pm2/logs/az-cars-backend-out.log || true
            tail -n 80 ~/.pm2/logs/az-cars-backend-error.log || true
